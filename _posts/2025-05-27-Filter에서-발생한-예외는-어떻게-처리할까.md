---
title: Filterì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ëŠ” ì–´ë–»ê²Œ ì²˜ë¦¬í• ê¹Œ
description: GlobalExceptionHandlerê°€ ì¡ì§€ ëª»í•˜ëŠ” ì˜ˆì™¸ ì²˜ë¦¬ ë°©ë²• (feat. AuthenticationEntryPoint)
author: kancho
date: 2025-05-26 22:06:00
categories: [Project, Pigrest]
tags: [Java, Spring, Filter, Exception]
pin: false
# math: true
# mermaid: true
---

## ê°œìš”

Expiredëœ Access Tokenì„ ë„˜ê²¨ì„œ, **`JwtAuthenticationFilter`**ì—ì„œ **`ExpiredJwtException`** ì´ ë°œìƒí–ˆë‹¤.

ê·¸ëŸ°ë° **`GlobalExceptionHandler`**ì— ì •ì˜í•´ë‘” ê³µí†µ ì‘ë‹µ í˜•ì‹ì´ ë°˜í™˜ë˜ì§€ ì•Šì•˜ë‹¤.

ğŸ˜¥ ë‹¹ì—°í•œ ê²°ê³¼ë‹¤... Spring MVCì— ë„ë‹¬í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì´ë‹¤...

<br/>

## âš ï¸ ë¬¸ì œ ì›ì¸

<img src="../assets/img/posts/jwt-filter-dispatcher-servlet.svg" />

Springì˜ `@ControllerAdvice` ë˜ëŠ” `@ExceptionHandler`ëŠ” Controller ë‚´ë¶€ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë§Œ ì²˜ë¦¬í•œë‹¤.

ë°˜ë©´ `JwtAuthenticationFilter` ëŠ” Spring MVC ì˜ì—­ì— ìˆëŠ” DispatcherServletì˜ ì´ì „ ë‹¨ê³„, ì¦‰ ì„œë¸”ë¦¿ Filter Chain ë‹¨ê³„ì—ì„œ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— GlobalExceptionHandlerê¹Œì§€ ë„ë‹¬í•˜ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ í´ë¼ì´ì–¸íŠ¸ëŠ” ì‘ë‹µ í˜•ì‹ ì—†ì´ `401` í˜¹ì€ `403` Http Status codeë§Œ ë°›ê²Œ ëœë‹¤.

ì´ë ‡ê²Œ ë˜ë©´ ì¼ê´€ëœ JSON êµ¬ì¡°ì˜ ì‘ë‹µì„ ê¸°ëŒ€í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì˜ˆì™¸ ì‘ë‹µì„ íŒŒì‹±í•  ë•Œ ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.

<br/>

## âœï¸ í•´ê²° ë°©ì•ˆ

Filter ë‚´ë¶€ì—ì„œ try-catchë¡œ Exceptionì„ ì¡ì•„ì„œ, ì‘ë‹µì„ ì§ì ‘ write í•´ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ í•´ê²°í–ˆë‹¤.

```java
// JwtAuthenticationFilter.class
catch (JwtException e) {
    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
    response.setContentType("application/json");
    response.getWriter().write(new ObjectMapper().writeValueAsString(
        ApiResponse.error(ApiStatusCode.INVALID_TOKEN, e.getMessage())));
    return;
}
```

> ì™œ `AuthenticationEntryPoint` ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ëŠ”ê°€
> Spring Securityì—ì„œ ì œê³µí•´ì£¼ëŠ” **`AuthenticationEntryPoint`**ë¥¼ ì»¤ìŠ¤í…€í•´ì„œ ì˜ˆì™¸ë¥¼ í•¸ë“¤ë§í•  ìˆ˜ ìˆëŠ”ë°, ì´ëŠ” **`AuthenticationException` ì˜ˆì™¸ë§Œ ì²˜ë¦¬**í•œë‹¤. JwtAuthenticationFilterì—ì„œëŠ” **ë‹¤ì–‘í•œ JwtExceptionì´ ë°œìƒ**í•˜ê³ , AuthenticationExceptionê³¼ëŠ” **ë‹¤ë¥¸ error ì½”ë“œë¥¼ ë°˜í™˜**í•˜ê¸° ë•Œë¬¸ì— Filter ë‚´ì—ì„œ ì§ì ‘ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì„ íƒí•˜ì˜€ë‹¤.
{: .prompt-info }

í•˜ì§€ë§Œ **(1) ì˜ˆì™¸ì— ë”°ë¼ ìƒíƒœ ì½”ë“œì™€ ë©”ì‹œì§€ê°€ ë‹¬ë¼ì ¸ì•¼** í•˜ëŠ” ìš”êµ¬ì‚¬í•­ì´ ìˆì—ˆê³ , ê·¸ë•Œë§ˆë‹¤ ì‘ë‹µì„ ì§ì ‘ ì‘ì„±í•˜ë‹¤ ë³´ë‹ˆ **(2) ì¤‘ë³µ ì½”ë“œ**ê°€ **ë°œìƒ**í•˜ê²Œ ë˜ì—ˆë‹¤.

<br/>

## ğŸŸ¨ 1ì°¨ ë¦¬íŒ©í† ë§: ì±…ì„ ë¶„ë¦¬

ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë¡œì§ì„ **ë³„ë„ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬**í•˜ì—¬, í•„í„°ì—ì„œëŠ” ì¸ì¦ ë¡œì§ì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ë‹¤.

```java
@Component  
@RequiredArgsConstructor  
public class FilterExceptionHandler {  
    private final ObjectMapper objectMapper;  
  
    public void handle(HttpServletResponse response, Exception e) throws IOException {  
        ApiStatusCode apiStatusCode = ApiStatusCode.INTERNAL_SERVER_ERROR;  
        String message = e.getMessage(); // ì´ˆê¸°í™”
  
        if (e instanceof JwtException) {  
            apiStatusCode = ApiStatusCode.INVALID_TOKEN;  
            message = "Invalid token. Please log in again."; // âš ï¸ ê°’ ë³€ê²½
        } else if (e instanceof AuthenticationException) {  
            apiStatusCode = ApiStatusCode.UNAUTHORIZED;  
            message = "Authentication failed. Please check your credentials.";  
        }  
  
        response.setStatus(apiStatusCode.getStatus());  
        response.setContentType("application/json");  
        objectMapper.writeValue(response.getWriter(), ApiResponse.error(apiStatusCode, message));  
    }  
}
```

ë‹¤ë§Œ ì¤‘ê°„ì— ìƒíƒœ ì½”ë“œì™€ ë©”ì‹œì§€ë¥¼ ë³€ê²½í•˜ëŠ” ë°©ì‹ì€ ë¶ˆë³€ì„±ì„ í•´ì¹˜ë©°, ìœ ì§€ë³´ìˆ˜ ì‹œ ì‹¤ìˆ˜ì˜ ì—¬ì§€ê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤.

<br/>

## âœ… 2ì°¨ ë¦¬íŒ©í† ë§: ë¶ˆë³€ì„± ë„ì…

1. ìƒíƒœ ì½”ë“œì™€ ë©”ì‹œì§€ë¥¼ í•¨ê»˜ ë‹´ëŠ” ë¶ˆë³€ ê°ì²´ `record ErrorInfo` ë„ì…
2. `getErrorInfo()` ë©”ì„œë“œê°€ ì˜ˆì™¸ ì¢…ë¥˜ì— ë”°ë¼ ë¶ˆë³€ì˜ `ErrorInfo` ê°ì²´ë¥¼ ë°˜í™˜í•˜ì—¬, ì•ˆì •ì„±ê³¼ ê°€ë…ì„± í–¥ìƒ 

```java
@Component
@RequiredArgsConstructor
public class FilterExceptionHandler {
    // ë¶ˆë³€ ê°ì²´ ErrorInfoë¡œ êµ¬ì„±
    private record ErrorInfo(ApiStatusCode statusCode, String message) {}

    private final ObjectMapper objectMapper;

    public void handle(HttpServletResponse response, Exception e) throws IOException {
        ErrorInfo error = getErrorInfo(e); // â­ ë¶ˆë³€ì„± í™•ë³´

        response.setStatus(error.statusCode().getStatus());
        response.setContentType("application/json");
        objectMapper.writeValue(response.getWriter(), ApiResponse.error(error.statusCode(), error.message()));
    }

    private ErrorInfo getErrorInfo(Exception e) {
        if (e instanceof JwtException) {
            return new ErrorInfo(ApiStatusCode.INVALID_TOKEN, "Invalid token. Please log in again.");
        } else if (e instanceof AuthenticationException) {
            return new ErrorInfo(ApiStatusCode.UNAUTHORIZED, "Authentication failed. Please check your credentials.");
        }
        return new ErrorInfo(ApiStatusCode.INTERNAL_SERVER_ERROR, "Internal Server Error");
    }
}
```

> í™•ì¥ì„±ì„ ê³ ë ¤í•˜ì—¬, ì˜ˆì™¸ ë¶„ê¸°ë¥¼ `Map<Class<? extends Exception>, ErrorInfo>` í˜•íƒœë¡œ êµ¬í˜„í•˜ëŠ” ë°©ì•ˆë„ ê³ ë ¤í–ˆì§€ë§Œ, ì˜ˆì™¸ì˜ í•˜ìœ„ íƒ€ì…ê¹Œì§€ ì²˜ë¦¬í•˜ë ¤ë©´ ì„±ëŠ¥ì ì¸ ë©´ì—ì„œ ë¹„íš¨ìœ¨ì ì´ê¸° ë•Œë¬¸ì—, ë‹¨ìˆœí•œ if-else ë°©ì‹ì„ ìœ ì§€í•˜ê¸°ë¡œ í–ˆë‹¤.

<br/>

## ğŸ¾ ì •ë¦¬í•˜ìë©´

- Filterì—ì„œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ëŠ” Spring MVC ì˜ì—­ì— ì¡´ì¬í•˜ëŠ” ExceptionHandlerì—ì„œ ì²˜ë¦¬ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ë³„ë„ë¡œ í•¸ë“¤ë§ì´ í•„ìš”í•˜ë‹¤.
- ì´ˆê¸°ì—ëŠ” Filter ë‚´ì— ì‘ë‹µì„ ì‘ì„±í–ˆìœ¼ë‚˜, ì±…ì„ ë¶„ë¦¬ ë° ë¶ˆë³€ì„± ë„ì…ì„ í†µí•´ ì½”ë“œ ì•ˆì •ì„±ì„ í–¥ìƒì‹œì¼°ë‹¤.


## ì°¸ê³ 

- [AuthenticationEntryPoint (spring-security-docs)](https://docs.spring.io/spring-security/reference/api/java/org/springframework/security/web/AuthenticationEntryPoint.html)
